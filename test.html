<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realm SMP - Discord Application</title>
<style>
body {
  font-family: 'Inter', system-ui, sans-serif;
  background:#111420;
  color:#eef0ff;
  padding:20px;
}
h1,h2 { margin-bottom:12px; }
input, textarea, button {
  display:block;
  width:100%;
  margin:8px 0;
  padding:12px;
  border-radius:8px;
  border:none;
  font-size:1rem;
}
button { background:#7a7cff; color:#0b0d12; font-weight:700; cursor:pointer; }
button:hover { background:#6569ff; }
form { margin-bottom:30px; }
</style>
</head>
<body>

<h1>Discord Application</h1>
<form id="appForm">
  <input type="text" id="appUsername" placeholder="Minecraft username (optional)">
  <textarea id="appMessage" placeholder="Why should you be approved?" rows="4"></textarea>
  <button type="submit">Submit Application</button>
</form>

<h2>Suggestions</h2>
<form id="suggestForm">
  <input type="text" id="sugUsername" placeholder="Minecraft username (optional)">
  <textarea id="sugMessage" placeholder="Your suggestion..." rows="4"></textarea>
  <button type="submit">Submit Suggestion</button>
</form>

<script>
// ===== CONFIG =====
const FORM_ENDPOINT = "https://formsubmit.co/ajax/ethan.sloss09@gmail.com"; // your email
const APPROVAL_CSV_URL = "https://docs.google.com/spreadsheets/d/e/1A1Mx4QbDbRRri0vmdmAlJIFvb7UWYK0G4ZlTIKi3dPw/pub?output=csv"; // your published sheet CSV
const DISCORD_INVITE = "https://discord.gg/YOURINVITE"; // replace with your Discord

// ===== TOKEN STORAGE =====
function genToken() {
  return Math.random().toString(36).substring(2, 12);
}
let userToken = localStorage.getItem("realmToken");

// ===== SUBMIT DISCORD APPLICATION =====
document.getElementById("appForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("appUsername").value.trim();
  const message = document.getElementById("appMessage").value.trim();
  if (!message) return alert("Please enter a message.");

  if (!userToken) {
    userToken = genToken();
    localStorage.setItem("realmToken", userToken);
  }

  const body = {
    username,
    message,
    token: userToken,
    approval_link: `${window.location.href}?token=${userToken}`
  };

  try {
    await fetch(FORM_ENDPOINT, {
      method:"POST",
      headers: {'Content-Type':'application/json', 'Accept':'application/json'},
      body: JSON.stringify(body)
    });
    alert("Application sent! Check back soon for approval.");
    e.target.reset();
  } catch(err) {
    console.error(err);
    alert("Error sending application.");
  }
});

// ===== SUBMIT SUGGESTION =====
document.getElementById("suggestForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("sugUsername").value.trim();
  const message = document.getElementById("sugMessage").value.trim();
  if (!message) return alert("Please enter a suggestion.");

  try {
    await fetch(FORM_ENDPOINT, {
      method:"POST",
      headers: {'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify({ username, message })
    });
    alert("Suggestion sent successfully!");
    e.target.reset();
  } catch(err) {
    console.error(err);
    alert("Error sending suggestion.");
  }
});

// ===== POLL GOOGLE SHEET FOR APPROVAL =====
async function checkApproval() {
  if (!userToken) return;
  try {
    const res = await fetch(APPROVAL_CSV_URL + "&t=" + Date.now());
    const text = await res.text();
    const rows = text.trim().split("\n");

    // Skip header row: id,username,approved
    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].split(",");
      const token = cells[0].trim();        // column A = id/token
      const status = cells[2].trim().toLowerCase(); // column C = approved/pending
      if (token === userToken && status === "approved") {
        alert("ðŸŽ‰ Your Discord application was approved!\nJoin: " + DISCORD_INVITE);
        localStorage.removeItem("realmToken");
        clearInterval(pollInterval);
        return;
      }
    }
  } catch(err) {
    console.error("Approval check error:", err);
  }
}

// Start polling every 5 seconds
const pollInterval = setInterval(checkApproval, 5000);
checkApproval();

</script>

</body>
</html>
